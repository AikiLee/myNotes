# B和B+树

[toc]

## B树及其操作

B树，又称为**多路平衡查找树**，其中，B树中的孩子结点的个数就是B树的*阶*，一颗B树其满足以下特性（下面文字中m指阶数，P指空指针，K指关键字）：

![202203282049202022-03-28](https://s2.loli.net/2022/03/28/R2joJxUWcCdr9sD.png)在图中，小圆点就是NULL的，他们可以指向子树，也可以用来返回查找失败的情况

- 1.每个结点之多有m棵子树，有m-1个关键字（规定），对于根结点，至少有两个子树和一个关键字

- 2.为了保证查找效率，非根非叶结点至少有有m/2(向上取整)棵子树，m/2(向上取整)-1个关键字

- 3.对于所有非叶节点，其有 右空> 关键字 >左空 这种情况。所有叶节点位于同一层次之上

B树适用于读写相对大的数据块的存储系统，例如磁盘。B树减少定位记录时所经历的中间过程，从而加快存取速度。B树这种数据结构可以用来描述外部存储。这种数据结构常被应用在数据库和文件系统的实现上。

### B树的查找

我们直接使用一个例子来演示：
![202203282103472022-03-28](https://s2.loli.net/2022/03/28/wXEhO4yNtuzF9QK.png)

如上图我要从上图中找到E字母，查找流程如下

（1）获取根节点的关键字进行比较，当前根节点关键字为M，E&lt;M（26个字母顺序），所以往找到指向左边的子节点（二分法规则，左小右大，左边放小于当前节点值的子节点、右边放大于当前节点值的子节点）；

（2）拿到关键字D和G，D&lt;E&lt; G 所以直接找到D和G中间的节点；

（3）拿到E和F，因为E=E 所以直接返回关键字和指针信息（如果树结构里面没有包含所要查找的节点则返回null）；

### B树的插入

相较于AST，B树的插入复杂的多。其满足以下规则：

- 1.其是一颗AST，满足其基本性质，具有顺序性

- 2.在插入的过程中需满足上面(1)(2)的基本性质，对于本满足这些情况的时候，就需要进行分裂（具体规则在例子中讲）

    ![202203282107252022-03-28](https://s2.loli.net/2022/03/28/rwjH5G3cRxuVfgA.png)插入步骤：
    1. 如果节点拥有的元素数量小于最大值，那么有空间容纳新的元素(本例中m=3,1<=关键字<=2,。将新元素插入到这一节点，且保持节点中元素有序。

    2. 否则的话这一节点已经满了，将它平均地分裂成两个节点：
        > (1)从该节点的原有元素和新的元素中选择出中位数
        (2)小于这一中位数的元素放入左边节点，大于这一中位数的元素放入右边节点，中位数作为分隔值。
        (3)分隔值被插入到父节点中，这可能会造成父节点分裂，分裂父节点时可能又会使它的父节点分裂，以此类推。如果没有父节点（这一节点是根节点），就创建一个新的根节点（增加了树的高度）。

下面再举一个例子：
定义一个5阶树（平衡5路查找树;），现在我们要把3、8、31、11、23、29、50、28、53 这些数字构建出一个5阶树出来;

- 插入3、8、31、11

![202203282134002022-03-28](https://s2.loli.net/2022/03/28/hBg6AK9fLIT3PYy.png)

- 插入23、29

![202203282134532022-03-28](https://s2.loli.net/2022/03/28/9Ba1MIwlPz8ECK3.png)

- 最后插入50、28、53

![202203282135402022-03-28](https://s2.loli.net/2022/03/28/AGXk2TlzC7fUp4S.png)

### B树的高

**最小高度**：即尽量取满。若以一颗m阶B树为例，关键字个数$n <= (m-1)(1+ m^2 + m^3 + ...+m^{h-1}) = m^h -1 就可以算出 h >= \log_m(n+1)$

**最大高度**：即尽量取到m/2(向上取整)个子树和m/2(向上取整)-1个关键字。
对于关键字有n的m阶B树，第一层有1，第二层有2，第三层至少$ 2\lceil m/2 \rceil$,依次类推，对于h+1层（空结点）有
$$ n+1 >= \lceil m/2 \rceil^{h-1} \\ h <= \log_{ \lceil m/2 \rceil}(\frac{n+1}{2}+1) $$

### B树的删除

分三种情况：

1. 若待删除的关键字，所在结点满足$>= \lceil m/2 \rceil$,删除该节点后仍满足B树的定义。

2. 兄弟足够借，即在删除结点之后，该节点不满足定义了，向左右兄弟结点借一个结点，使之满足定义（会发生旋转，只针对关键字，不针对结点）

    ![202203282138452022-03-28](https://s2.loli.net/2022/03/28/dtNc7oe6KkRmiXJ.png)

3. 兄弟不够借，此时向兄弟借，会破坏兄弟结点的稳定，此时需要进行合并（分裂的逆步骤）
![202203282143162022-03-28](https://s2.loli.net/2022/03/28/yfQnd69uZ7TD5qm.png)这是一个5阶B树，此时正在删除关键字5

![202203282141432022-03-28](https://s2.loli.net/2022/03/28/kJZ93maMQF7Tj8V.png)

![202203282142102022-03-28](https://s2.loli.net/2022/03/28/OuEZsqtVDNz6U1b.png)

注：删除关键字，不代表结点被删除了。(王道DS p301 T12)

## B+树及其操作

B+ 树是一种树数据结构，通常用于数据库和操作系统的文件系统中。B+ 树的特点是能够保持数据稳定有序，其插入与修改拥有较稳定的对数时间复杂度。B+ 树元素自底向上插入，这与二叉树恰好相反。

### 定义

1. 每个分支结点最多有m棵子树，结点的子树和关键字个数相同

2. 所有叶节点包含关键字及指向相应记录的**指针**，叶节点中讲关键字按大小排序，并且相邻的叶节点按大小顺序相互链接

3. 所有的分支结点包含其各**子节点**中关键字的最大值及指向子节点的指针

与B树的主要差异：

- 关键字可以有m个

- 非根内部结点为$ [\lceil m/2 \rceil,m]根结点为[2,m]$;相较于B树$ [\lceil m/2 \rceil -1,m-1]根结点为[1,m-1]$

- B+ 树中，叶节点包含所有关键字，，非叶节点每个索引项只是指针，而不包含地址

![202203282157212022-03-28](https://s2.loli.net/2022/03/28/dNnAYk7SXiVQf3s.png)

注：B树的范围查找用的是中序遍历，而B+树用的是在链表上遍历；

## 参考

[B和B+树](https://www.cnblogs.com/lianzhilei/p/11250589.html)
